/**
 * @file Firestore Security Rules for Vidyalaya Connect
 * @description This ruleset enforces role-based access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Controls access to user profiles.
     * - Admins can read/write any user.
     * - Users can read/write their own profile.
     * - Any signed-in user can list other users for now. This should be restricted later.
     */
    match /users/{userId} {
      allow read: if isSignedIn() && (getUserData(request.auth.uid).role == 'admin' || isOwner(userId));
      allow list: if isSignedIn(); // Simplified rule to allow any authenticated user to list
      allow write: if isSignedIn() && (getUserData(request.auth.uid).role == 'admin' || isOwner(userId));
    }

    /**
     * @description Controls access to notices.
     * - Anyone can read notices.
     * - Admins can write/delete notices.
     */
    match /notices/{noticeId} {
      allow read: if true;
      allow write, delete: if isSignedIn() && getUserData(request.auth.uid).role == 'admin';
    }
    
    /**
     * @description Controls access to results.
     * - Admins/Teachers can read/write all results.
     * - Parents/Students can only read their own (or their child's) results.
     */
    match /results/{resultId} {
        allow read: if isSignedIn() && (getUserData(request.auth.uid).role == 'admin' || getUserData(request.auth.uid).role == 'teacher' || isOwner(resource.data.studentId));
        allow list: if isSignedIn() && (getUserData(request.auth.uid).role == 'admin' || getUserData(request.auth.uid).role == 'teacher');
        allow write: if isSignedIn() && (getUserData(request.auth.uid).role == 'admin' || getUserData(request.auth.uid).role == 'teacher');
    }

    /**
     * @description Controls access to homework.
     * - Admins/Teachers can read/write homework.
     * - Parents/Students can only read homework for their class.
     */
    match /homeworks/{homeworkId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && (getUserData(request.auth.uid).role == 'admin' || getUserData(request.auth.uid).role == 'teacher');
    }

    /**
     * @description Controls access to attendance.
     * - Admins/Teachers can read/write attendance.
     * - Parents/Students can only read their own attendance.
     */
     match /attendance/{attendanceId} {
        allow read: if isSignedIn() && (getUserData(request.auth.uid).role == 'admin' || getUserData(request.auth.uid).role == 'teacher' || isOwner(resource.data.studentId));
        allow list: if isSignedIn() && (getUserData(request.auth.uid).role == 'admin' || getUserData(request.auth.uid).role == 'teacher');
        allow write: if isSignedIn() && (getUserData(request.auth.uid).role == 'admin' || getUserData(request.auth.uid).role == 'teacher');
     }
  }
}
