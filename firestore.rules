/**
 * @file Firestore Security Rules for Vidyalaya Connect
 * @description This ruleset enforces role-based access control for the application.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserRole(uid) {
        return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }

    /**
     * @description Controls access to user profiles.
     * - A user can read/write their own profile.
     * - An admin or teacher can read any profile.
     * - An admin or teacher can create a user profile.
     */
    match /users/{userId} {
      allow read: if isSignedIn() && (isOwner(userId) || getUserRole(request.auth.uid) in ['admin', 'teacher']);
      allow write: if isSignedIn() && (isOwner(userId) || getUserRole(request.auth.uid) in ['admin', 'teacher']);
      allow list: if isSignedIn();
    }

    /**
     * @description Controls access to notices.
     * - Anyone can read notices.
     * - Authenticated users can create notices (UI restricts this to admins).
     * - Admins can update or delete notices.
     */
    match /notices/{noticeId} {
      allow read: if true;
      allow create: if isSignedIn() && getUserRole(request.auth.uid) == 'admin';
      allow update, delete: if isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }

    /**
     * @description Controls access to student results.
     * - Admins and Teachers can create results.
     * - Admins, Teachers, Parents and Students can only read/update/delete results where their ID matches the studentId.
     * - List is open to signed in users, client will filter.
     */
    match /results/{resultId} {
        allow create: if isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'teacher'];
        allow read, update, delete: if isSignedIn() && (getUserRole(request.auth.uid) in ['admin', 'teacher'] || isOwner(resource.data.studentId));
        allow list: if isSignedIn();
    }

    /**
     * @description Controls access to homework assignments.
     * - Any signed-in user can read/list homework (rules on the client filter by class).
     * - Only Admins and Teachers can create or modify homework.
     */
    match /homeworks/{homeworkId} {
        allow read: if isSignedIn();
        allow list: if isSignedIn();
        allow write: if isSignedIn() && getUserRole(request.auth.uid) in ['admin', 'teacher'];
    }

    /**
     * @description Controls access to attendance records.
     * - Admins and Teachers can read/write all attendance records.
     * - Parents and Students can only read attendance records linked to their own ID.
     * - List is open to signed in users, client will filter.
     */
     match /attendance/{attendanceId} {
        allow write: if isSignedIn() && getUserRole(request.auth.uid) in ['admin', 'teacher'];
        allow read: if isSignedIn() && (getUserRole(request.auth.uid) in ['admin', 'teacher'] || isOwner(resource.data.studentId));
        allow list: if isSignedIn();
     }
  }
}
