/**
 * @file Firestore Security Rules for Vidyalaya Connect
 * @description This ruleset enforces role-based access control for the application.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData(userId) {
        return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    /**
     * @description Controls access to user profiles.
     * - A user can read/write their own profile.
     * - An admin or teacher can read any profile.
     * - Any signed-in user can create their own profile.
     */
    match /users/{userId} {
      allow read: if isSignedIn();
      allow update, delete: if isSignedIn() && (isOwner(userId) || getUserData(request.auth.uid).role in ['admin', 'teacher']);
      allow create: if isSignedIn();
      allow list: if isSignedIn();
    }

    /**
     * @description Controls access to notices.
     * - Anyone can read notices.
     * - Admins can create, update, or delete notices.
     */
    match /notices/{noticeId} {
      allow read: if true;
      allow write: if isSignedIn() && getUserData(request.auth.uid).role == 'admin';
    }

    /**
     * @description Controls access to student results.
     * - Admins and Teachers can create results.
     * - Admins, Teachers, Parents and Students can only read/update/delete results where their ID matches the studentId.
     * - List is open to signed in users, client will filter.
     */
    match /results/{resultId} {
        allow create: if isSignedIn();
        allow read, update, delete: if isSignedIn() && (getUserData(request.auth.uid).role in ['admin', 'teacher'] || isOwner(resource.data.studentId));
        allow list: if isSignedIn();
    }

    /**
     * @description Controls access to homework assignments.
     * - Any signed-in user can read/list homework (rules on the client filter by class).
     * - Only Admins and Teachers can create or modify homework.
     */
    match /homeworks/{homeworkId} {
        allow read, list: if isSignedIn();
        allow write: if isSignedIn() && getUserData(request.auth.uid).role in ['admin', 'teacher'];
    }

    /**
     * @description Controls access to attendance records.
     * - Admins and Teachers can read/write all attendance records.
     * - Parents and Students can only read attendance records linked to their own ID.
     * - List is open to signed in users, client will filter.
     */
     match /attendance/{attendanceId} {
        allow write: if isSignedIn() && getUserData(request.auth.uid).role in ['admin', 'teacher'];
        allow read: if isSignedIn() && (getUserData(request.auth.uid).role in ['admin', 'teacher'] || isOwner(resource.data.studentId));
        allow list: if isSignedIn();
     }

    /**
     * @description Controls access to fee records.
     * - Admins and Teachers can read/write all fee records.
     * - Parents and Students can only read fee records linked to their own ID.
     */
    match /fees/{feeId} {
      allow write: if isSignedIn() && getUserData(request.auth.uid).role in ['admin', 'teacher'];
      allow read: if isSignedIn() && (getUserData(request.auth.uid).role in ['admin', 'teacher'] || isOwner(resource.data.studentId));
      allow list: if isSignedIn() && getUserData(request.auth.uid).role in ['admin', 'teacher'];
    }

    /**
     * @description Controls access to leave applications.
     * - Admins can read, list, and update all applications.
     * - Students can create applications for themselves.
     */
    match /leave-applications/{applicationId} {
      allow read, list, update: if isSignedIn() && getUserData(request.auth.uid).role == 'admin';
      allow create: if isSignedIn() && (isOwner(request.resource.data.studentId));
    }
    
    /**
     * @description Controls access to live class sessions.
     * - All signed-in users can read/list live classes.
     * - Only admins and teachers can create or update live classes.
     * - Teachers can only update classes they started.
     */
    match /live-classes/{classId} {
      allow read, list: if isSignedIn();
      allow create: if isSignedIn() && getUserData(request.auth.uid).role in ['admin', 'teacher'];
      allow update: if isSignedIn() && (getUserData(request.auth.uid).role == 'admin' || (getUserData(request.auth.uid).role == 'teacher' && resource.data.teacherId == request.auth.uid));
    }

    /**
     * @description Controls access to the video gallery.
     * - All signed-in users can view the video list and individual videos.
     * - Only admins can create, update, or delete videos.
     */
    match /videos/{videoId} {
      allow read, list: if isSignedIn();
      allow write: if isSignedIn() && getUserData(request.auth.uid).role == 'admin';
    }

     /**
     * @description Controls access to the photo gallery.
     * - All signed-in users can view the photo list and individual photos.
     * - Only admins can create, update, or delete photos.
     */
    match /photos/{photoId} {
      allow read, list: if isSignedIn();
      allow write: if isSignedIn() && getUserData(request.auth.uid).role == 'admin';
    }

    /**
     * @description Controls access to parent-teacher queries.
     * - Parents can create queries for their own children.
     * - Parents can read queries they created.
     * - Teachers and Admins can read all queries.
     * - Teachers and Admins can update (reply to) queries.
     */
    match /messages/{messageId} {
      allow create: if isSignedIn() && getUserData(request.auth.uid).role == 'parent' && isOwner(request.resource.data.parentId);
      allow read: if isSignedIn() && (getUserData(request.auth.uid).role in ['admin', 'teacher'] || isOwner(resource.data.parentId));
      allow update: if isSignedIn() && getUserData(request.auth.uid).role in ['admin', 'teacher'];
      allow list: if isSignedIn();
    }

     /**
     * @description Controls access to student health records.
     * - Only admins and teachers can read and write health records.
     * - This data is confidential and not accessible by parents or students.
     */
    match /health-records/{studentId} {
      allow read, write: if isSignedIn() && getUserData(request.auth.uid).role in ['admin', 'teacher'];
    }
  }
}

    