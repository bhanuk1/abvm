/**
 * @file Firestore Security Rules for Vidyalaya Connect
 * @description This ruleset enforces role-based access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isRole(role) {
      return isSignedIn() && getUserData().role == role;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Controls access to user profiles.
     * - Admins can read/write any user.
     * - Users can read/write their own profile.
     * - Teachers can list students.
     */
    match /users/{userId} {
      allow read: if isRole('admin') || isOwner(userId);
      allow list: if isRole('admin') || isRole('teacher');
      allow write: if isRole('admin') || isOwner(userId);
    }

    /**
     * @description Controls access to notices.
     * - Anyone can read notices.
     * - Admins can write/delete notices.
     */
    match /notices/{noticeId} {
      allow read: if true;
      allow write, delete: if isRole('admin');
    }
    
    /**
     * @description Controls access to results.
     * - Admins/Teachers can read/write all results.
     * - Parents/Students can only read their own (or their child's) results.
     */
    match /results/{resultId} {
        allow read: if isRole('admin') || isRole('teacher') || (isOwner(resource.data.studentId));
        allow list: if isRole('admin') || isRole('teacher');
        allow write: if isRole('admin') || isRole('teacher');
    }

    /**
     * @description Controls access to homework.
     * - Admins/Teachers can read/write homework.
     * - Parents/Students can only read homework for their class.
     */
    match /homeworks/{homeworkId} {
        allow read: if isSignedIn();
        allow write: if isRole('admin') || isRole('teacher');
    }

    /**
     * @description Controls access to attendance.
     * - Admins/Teachers can read/write attendance.
     * - Parents/Students can only read their own attendance.
     */
     match /attendance/{attendanceId} {
        allow read: if isRole('admin') || isRole('teacher') || (isOwner(resource.data.studentId));
        allow list: if isRole('admin') || isRole('teacher');
        allow write: if isRole('admin') || isRole('teacher');
     }
  }
}
