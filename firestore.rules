/**
 * @file Firestore Security Rules for Vidyalaya Connect
 * @description This ruleset enforces a user-ownership model for user profiles and a public-read, owner-write model for notices.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data. Only the user with the matching {userId} can read or write their profile.
 * - /notices/{noticeId}: Stores notices. Visibility is controlled by the 'role' field in the notice document.
 *
 * Key Security Decisions:
 * - User profiles are private to the owner, but other signed-in users can list them (e.g., for directories).
 * - Notices are publicly readable.
 * - Only the author can create, update, or delete their notices.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Controls access to user profiles. Only the user with the matching ID can read or write their own profile.
     * @path /users/{userId}
     * @principle Enforces document ownership for write operations. Allows read for any signed-in user.
     */
    match /users/{userId} {
      function isOwner() {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOwner() && request.resource.data.id == userId;
      allow update: if isOwner() && request.resource.data.id == resource.data.id;
      allow delete: if isOwner();
    }

    /**
     * @description Controls access to notices.
     * @path /notices/{noticeId}
     * @principle Allows public read access, but enforces document ownership for write operations.
     */
    match /notices/{noticeId} {
       function isAuthor() {
         return request.auth.uid == resource.data.authorId;
       }

       function isNewAuthor() {
         return request.auth.uid == request.resource.data.authorId;
       }

      allow read: if true;
      allow create: if isSignedIn() && isNewAuthor();
      allow update: if isSignedIn() && isAuthor();
      allow delete: if isSignedIn() && isAuthor();
    }
  }
}
