/**
 * @file Firestore Security Rules for Vidyalaya Connect
 * @description This ruleset enforces role-based access control for the application.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserRole() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    /**
     * @description Controls access to user profiles.
     * - Admins can read/write any user profile.
     * - Users can read/write their own profile.
     * - Any authenticated user can list users (e.g., for selection lists).
     */
    match /users/{userId} {
      allow read, write: if isSignedIn() && (getUserRole() == 'admin' || isOwner(userId));
      allow list: if isSignedIn();
    }

    /**
     * @description Controls access to notices.
     * - Anyone (authenticated or not) can read notices.
     * - Only admins can create, update, or delete notices.
     */
    match /notices/{noticeId} {
      allow read: if true;
      allow write: if isSignedIn() && getUserRole() == 'admin';
    }
    
    /**
     * @description Controls access to student results.
     * - Admins and Teachers can read/list/write all results.
     * - Parents and Students can only read results where their ID matches the studentId.
     */
    match /results/{resultId} {
        allow read, write: if isSignedIn() && (getUserRole() == 'admin' || getUserRole() == 'teacher' || isOwner(resource.data.studentId));
        allow list: if isSignedIn() && (getUserRole() == 'admin' || getUserRole() == 'teacher');
    }

    /**
     * @description Controls access to homework assignments.
     * - Any signed-in user can read homework (rules on the client filter by class).
     * - Only Admins and Teachers can create or modify homework.
     */
    match /homeworks/{homeworkId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && (getUserRole() == 'admin' || getUserRole() == 'teacher');
    }

    /**
     * @description Controls access to attendance records.
     * - Admins and Teachers can read/list/write all attendance records.
     * - Parents and Students can only read attendance records linked to their own ID.
     */
     match /attendance/{attendanceId} {
        allow read, write: if isSignedIn() && (getUserRole() == 'admin' || getUserRole() == 'teacher' || isOwner(resource.data.studentId));
        allow list: if isSignedIn() && (getUserRole() == 'admin' || getUserRole() == 'teacher');
     }
  }
}
